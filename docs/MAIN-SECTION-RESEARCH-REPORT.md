# Main Section and Multi-Domain Routing – Research Report

This document synthesizes research conducted for adding a `/main` public marketing section served at www.moodmnky.com within the mood-mnky-command monorepo, with host-based routing, multi-domain auth, section-specific metadata and PWA behavior, and public marketing site design patterns.

---

## Knowledge Development

The investigation began from the requirement to serve three distinct experiences from one Next.js deployment: LABZ at mnky-command.moodmnky.com (root), MNKY VERSE at mnky-verse.moodmnky.com (/verse), and a new public marketing site at www.moodmnky.com (/main). Early findings confirmed that Next.js does not provide built-in domain routing; the host header must be read in edge or Node proxy logic and used to rewrite the request to the appropriate path prefix. Next.js 16’s rename from middleware to proxy does not change this approach: the exported proxy function still receives NextRequest and returns NextResponse, and NextResponse.rewrite() remains the mechanism for internal path rewriting without changing the browser URL. Vercel’s own multi-tenant and hostname-rewrite templates use this same pattern: read host, compute target path, rewrite. A critical nuance emerged that the rewrite must occur before any session or auth logic so that the session layer sees the final pathname (e.g. /main or /verse) when deciding whether to require authentication.

For multi-domain auth, Supabase’s documentation makes a clear distinction between the Site URL (single default, used when no redirectTo is specified, no wildcards) and the Redirect URLs allow list, which supports multiple exact URLs and wildcard patterns such as `https://www.moodmnky.com/**`. Adding www.moodmnky.com to the redirect list is therefore the correct way to allow auth flows that complete on the main marketing domain. Shopify’s Customer Account API similarly allows multiple Callback URLs and JavaScript origins; adding https://www.moodmnky.com/api/customer-account-api/callback and the origin www.moodmnky.com is supported and required if the main site will trigger login or link to Verse. Session cookie scope was noted as a potential limitation: if the three domains do not share a parent domain, cookies set on one (e.g. mnky-command.moodmnky.com) are not sent to www.moodmnky.com; in our case moodmnky.com is the parent, so with correct cookie domain configuration (e.g. .moodmnky.com where supported) or same-site behavior, cross-subdomain session sharing may be possible for same-site navigations, but the primary use case for Main is unauthenticated public pages, with CTAs that send users to Verse or Labz for login.

Section-specific metadata in Next.js is achieved by defining generateMetadata or static metadata in the layout of each route group; the (main) group’s layout will override the root layout’s metadata for all /main routes. Multiple root layouts (each with their own html/body) are possible with route groups but not required here; a single root layout with section-specific metadata from nested layouts is sufficient. PWA documentation for Next.js describes a single app/manifest.ts (or manifest.json) at the app level; the report did not find official guidance for section-specific manifests. The practical approach is to keep one manifest and add /main to precache entries so the main landing is available offline; a separate manifest for Main could be added later if the product demands it.

Public marketing site design research emphasized hero structure (background, tagline, one primary CTA), concise copy (e.g. tagline length limits), and design tokens for colors, typography, spacing, and motion to support theming and accessibility. Accessibility requirements include contrast ratios (4.5:1 for body text, 3:1 for focus indicators), semantic HTML, keyboard navigation, and screen reader considerations. These align with the project’s existing use of shadcn and DESIGN-SYSTEM.md; the Main section can either reuse root (globals.css) tokens for a clean public look or introduce a scoped main-site.css with optional --main-* tokens for a distinct brand portal feel, documented in DESIGN-SYSTEM.md.

---

## Comprehensive Analysis

Host-based rewriting in Next.js 16 is implemented in the proxy (formerly middleware) by reading request.headers.get("host"), normalizing (e.g. stripping port), and calling NextResponse.rewrite(new URL(rewrittenPath, request.url)). The matcher config must cover the paths that should be rewritten; for “all non-static requests” the existing pattern that excludes _next, static assets, and OAuth callbacks is appropriate. The order of operations matters: first apply the host rewrite so that the request’s pathname reflects the target section, then run updateSession so that public path checks (e.g. pathname.startsWith("/main")) and role-based redirects see the correct path. Vercel preview deployments use URLs like project--branch.vercel.app; the host header in previews will not be mnky-verse or www.moodmnky.com. Options include leaving preview deployments without host-based rewrite (so they behave like the default domain), or using an environment variable or convention (e.g. a query parameter) to simulate a section for testing; the former is simpler and recommended unless preview-per-section testing is required.

Supabase Auth supports multiple redirect URLs via the dashboard (Authentication → URL Configuration). Adding https://www.moodmnky.com and https://www.moodmnky.com/** (or equivalent wildcard) allows auth callbacks to land on the main domain. The Site URL can remain the primary app URL (e.g. mnky-command.moodmnky.com); it is used when no redirectTo is passed. For Shopify Customer Account API, the Hydrogen/application setup allows multiple Callback URI(s) and JavaScript origin(s); adding the main domain’s callback and origin is required if Main will initiate login or redirect to Verse. No code changes to Supabase or Shopify are strictly required for “public only” Main pages; the documentation and dashboard checklist are necessary so that when Main gains auth-triggering CTAs, the configuration is already in place.

Metadata and PWA behavior are well served by defining generateMetadata in (main)/main/layout.tsx with title, description, and Open Graph tags for the marketing site. The root layout’s metadata will be overridden for /main routes. A single manifest at the app root is sufficient; adding /main to Serwist’s additionalPrecacheEntries ensures the main landing is cached for offline. Section-specific manifests would require a separate manifest route and optional logic to serve different manifests by host or path; this is an optional enhancement.

Design patterns for the Main landing align with the project’s existing stack: shadcn for structure (Card, Button, etc.), optional Magic UI for motion, and root or scoped design tokens. Hero best practices (short tagline, single primary CTA, semantic structure) and accessibility (contrast, focus, keyboard, screen readers) should be applied; the design skill and DESIGN-SYSTEM.md provide the reference for tokens and components.

---

## Practical Implications

Implementation should create the (main) route group with its own layout and metadata, then add host-based rewrite logic at the start of the proxy so that requests to www.moodmnky.com (and optionally moodmnky.com) are rewritten to /main before updateSession runs. Public path logic in updateSession should treat pathname.startsWith("/main") as public. Vercel project settings should add www.moodmnky.com (and moodmnky.com if desired) as custom domains; no separate deployment is needed. Supabase Dashboard and Shopify Customer Account API settings should be updated per the checklists in the new MAIN-SECTION-SUPABASE-AUTH and related docs. Preview deployments can default to the existing behavior (no host rewrite) unless the team introduces an explicit preview-section override. Environment variables (e.g. NEXT_PUBLIC_MAIN_APP_URL) should be used for canonical Main URL in metadata, sitemap, and CTAs to avoid hardcoding. Navigation in-app and in the Shopify theme should link to the main site using that URL or /main as appropriate. Testing should include local hosts file entries for the three domains and verification that each host serves the correct section and that unauthenticated access to /main works. Documentation (MAIN-SECTION-DOMAINS, MAIN-SECTION-SUPABASE-AUTH, MAIN-SECTION-NAVIGATION, MAIN-SECTION-ROLLOUT, DESIGN-SYSTEM update) ensures the approach is repeatable and maintainable.

---

## Limitations and Gaps

Research did not validate cookie behavior across moodmnky.com subdomains in a live Supabase setup; if future features require a single sign-on across www, mnky-verse, and mnky-command, additional testing and possibly Supabase cookie domain configuration may be needed. Next.js 16 proxy default runtime (Node vs Edge) may affect header availability or performance; the codebase already uses proxy.ts successfully. Vercel preview URL handling for “test Main on preview” was not explored in depth; the recommendation is to rely on production-like domains (or hosts file) for host-based testing. PWA section-specific manifest and offline behavior for /main were not prototyped; the plan’s optional “section-specific manifest” remains an optional follow-up.

---

## Sources

- Next.js: middleware-to-proxy migration, proxy.ts API, generateMetadata, route groups, PWA manifest (nextjs.org).
- Vercel: hostname rewrites, multi-tenant template, rewrites, preview deployments, environment variables (vercel.com).
- Supabase: Redirect URLs, URL Configuration, wildcard patterns (supabase.com/docs).
- Shopify: Customer Account API, callback URLs, JavaScript origins, Hydrogen (shopify.dev).
- Design/accessibility: hero CTA patterns, contrast ratios, semantic HTML, focus indicators (designsystem.cancer.gov, primer.style, design system references).
