{
  "name": "showBlendSuggestions",
  "color": "#6366f1",
  "description": "REQUIRED after calculateBlendProportions. Present the blend suggestion with oils and proportions to the user. Do not merely describe the blend in text. Call this tool so the user sees the structured output. Include a short explanation of why this blend works.",
  "schema": "[{\"property\":\"oils\",\"type\":\"string\",\"description\":\"JSON array of { oilId, oilName }\",\"required\":true},{\"property\":\"proportions\",\"type\":\"string\",\"description\":\"JSON array of { oilId, oilName, proportionPct }\",\"required\":true},{\"property\":\"explanation\",\"type\":\"string\",\"description\":\"Short explanation of why this blend works\",\"required\":false}]",
  "func": "const baseUrl = String($vars.moodMnkyApiUrl || '').replace(/\\/+$/, '');\nconst apiKey = $vars.moodMnkyApiKey;\n\nif (!baseUrl) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiUrl' });\nif (!apiKey) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiKey (Runtime var / env)' });\nif (!$vars.userId) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.userId (override vars.userId from embed)' });\n\nconst fetchFn = (typeof fetch === 'function') ? fetch : (globalThis && globalThis.fetch) ? globalThis.fetch.bind(globalThis) : require('node-fetch');\n\nconst body = {\n  userId: $vars.userId,\n  sessionId: $flow.sessionId,\n  chatId: $flow.chatId,\n  oils: typeof $oils === 'string' ? JSON.parse($oils) : $oils,\n  proportions: typeof $proportions === 'string' ? JSON.parse($proportions) : $proportions,\n  explanation: typeof $explanation !== 'undefined' ? $explanation : undefined,\n};\n\nconst timeoutMs = 15000;\nconst controller = typeof AbortController !== 'undefined' ? new AbortController() : null;\nconst timer = controller ? setTimeout(() => controller.abort(), timeoutMs) : null;\n\ntry {\n  const res = await fetchFn(`${baseUrl}/api/flowise/tools/blend-suggestions`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n      'x-moodmnky-session-id': String($flow.sessionId || ''),\n      'x-moodmnky-chat-id': String($flow.chatId || ''),\n      'x-moodmnky-chatflow-id': String($flow.chatflowId || ''),\n    },\n    body: JSON.stringify(body),\n    ...(controller ? { signal: controller.signal } : {}),\n  });\n  const text = await res.text();\n  if (!res.ok) {\n    return JSON.stringify({ ok: false, layer: 'moodmnky_api', status: res.status, statusText: res.statusText, body: text?.slice(0, 2000) });\n  }\n  try { return JSON.stringify(JSON.parse(text)); } catch { return text; }\n} catch (err) {\n  const msg = err?.name === 'AbortError' ? `Request timed out after ${timeoutMs}ms` : (err?.message || String(err));\n  return JSON.stringify({ ok: false, layer: 'network', error: err?.name || 'Error', message: msg });\n} finally {\n  if (timer) clearTimeout(timer);\n}"
}
