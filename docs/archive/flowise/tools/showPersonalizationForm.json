{
  "name": "showPersonalizationForm",
  "color": "#6366f1",
  "description": "Show a personalization form to collect blend name and optional signature. Use when the user has confirmed their blend but has NOT yet provided a name (e.g. they said \"I like it\" or \"let's save it\"). Only call saveCustomBlend directly when they explicitly gave a name (e.g. \"Save as Cozy Vanilla\").",
  "schema": "[{\"property\":\"blendSummary\",\"type\":\"string\",\"description\":\"JSON: { productType, fragrances: [{ oilId, oilName, proportionPct }], batchWeightG?, fragranceLoadPct?, notes? }\",\"required\":true},{\"property\":\"promptForImage\",\"type\":\"string\",\"description\":\"Optional prompt for AI image generation\",\"required\":false}]",
  "func": "const baseUrl = String($vars.moodMnkyApiUrl || '').replace(/\\/+$/, '');\nconst apiKey = $vars.moodMnkyApiKey;\n\nif (!baseUrl) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiUrl' });\nif (!apiKey) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiKey (Runtime var / env)' });\nif (!$vars.userId) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.userId (override vars.userId from embed)' });\n\nconst fetchFn = (typeof fetch === 'function') ? fetch : (globalThis && globalThis.fetch) ? globalThis.fetch.bind(globalThis) : require('node-fetch');\n\nconst body = {\n  userId: $vars.userId,\n  sessionId: $flow.sessionId,\n  chatId: $flow.chatId,\n  blendSummary: typeof $blendSummary === 'string' ? JSON.parse($blendSummary) : $blendSummary,\n  promptForImage: typeof $promptForImage !== 'undefined' ? $promptForImage : undefined,\n};\n\nconst timeoutMs = 15000;\nconst controller = typeof AbortController !== 'undefined' ? new AbortController() : null;\nconst timer = controller ? setTimeout(() => controller.abort(), timeoutMs) : null;\n\ntry {\n  const res = await fetchFn(`${baseUrl}/api/flowise/tools/personalization-form`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n      'x-moodmnky-session-id': String($flow.sessionId || ''),\n      'x-moodmnky-chat-id': String($flow.chatId || ''),\n      'x-moodmnky-chatflow-id': String($flow.chatflowId || ''),\n    },\n    body: JSON.stringify(body),\n    ...(controller ? { signal: controller.signal } : {}),\n  });\n  const text = await res.text();\n  if (!res.ok) {\n    return JSON.stringify({ ok: false, layer: 'moodmnky_api', status: res.status, statusText: res.statusText, body: text?.slice(0, 2000) });\n  }\n  try { return JSON.stringify(JSON.parse(text)); } catch { return text; }\n} catch (err) {\n  const msg = err?.name === 'AbortError' ? `Request timed out after ${timeoutMs}ms` : (err?.message || String(err));\n  return JSON.stringify({ ok: false, layer: 'network', error: err?.name || 'Error', message: msg });\n} finally {\n  if (timer) clearTimeout(timer);\n}"
}
