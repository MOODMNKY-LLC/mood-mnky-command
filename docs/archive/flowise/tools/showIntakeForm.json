{
  "name": "showIntakeForm",
  "color": "#6366f1",
  "description": "Show an intake form to collect mood, product type, fragrance hints. Call when the user is starting a blend and getLatestFunnelSubmission returned no submission or null. Returns funnelId, runId, formSchema.",
  "schema": "[{\"property\":\"funnelId\",\"type\":\"string\",\"description\":\"Funnel definition ID. Omit to use first active funnel.\",\"required\":false}]",
  "func": "const baseUrl = String($vars.moodMnkyApiUrl || '').replace(/\\/+$/, '');\nconst apiKey = $vars.moodMnkyApiKey;\n\nif (!baseUrl) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiUrl' });\nif (!apiKey) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiKey (Runtime var / env)' });\nif (!$vars.userId) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.userId (override vars.userId from embed)' });\n\nconst fetchFn = (typeof fetch === 'function') ? fetch : (globalThis && globalThis.fetch) ? globalThis.fetch.bind(globalThis) : require('node-fetch');\n\nconst body = { userId: $vars.userId, sessionId: $flow.sessionId, chatId: $flow.chatId };\nif (typeof $funnelId !== 'undefined' && $funnelId) body.funnelId = $funnelId;\n\nconst timeoutMs = 15000;\nconst controller = typeof AbortController !== 'undefined' ? new AbortController() : null;\nconst timer = controller ? setTimeout(() => controller.abort(), timeoutMs) : null;\n\ntry {\n  const res = await fetchFn(`${baseUrl}/api/flowise/tools/intake-form`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n      'x-moodmnky-session-id': String($flow.sessionId || ''),\n      'x-moodmnky-chat-id': String($flow.chatId || ''),\n      'x-moodmnky-chatflow-id': String($flow.chatflowId || ''),\n    },\n    body: JSON.stringify(body),\n    ...(controller ? { signal: controller.signal } : {}),\n  });\n  const text = await res.text();\n  if (!res.ok) {\n    return JSON.stringify({ ok: false, layer: 'moodmnky_api', status: res.status, statusText: res.statusText, body: text?.slice(0, 2000) });\n  }\n  try { return JSON.stringify(JSON.parse(text)); } catch { return text; }\n} catch (err) {\n  const msg = err?.name === 'AbortError' ? `Request timed out after ${timeoutMs}ms` : (err?.message || String(err));\n  return JSON.stringify({ ok: false, layer: 'network', error: err?.name || 'Error', message: msg });\n} finally {\n  if (timer) clearTimeout(timer);\n}"
}
