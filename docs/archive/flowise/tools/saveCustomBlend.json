{
  "name": "saveCustomBlend",
  "color": "#6366f1",
  "description": "Save a custom fragrance blend for the user. Use when they confirm they are satisfied with their blend and want to save it. Include a descriptive name and notes.",
  "schema": "[{\"property\":\"name\",\"type\":\"string\",\"description\":\"Descriptive name for the blend\",\"required\":true},{\"property\":\"productType\",\"type\":\"string\",\"description\":\"Product type: candle, soap, etc.\",\"required\":true},{\"property\":\"fragrances\",\"type\":\"string\",\"description\":\"JSON array of { oilId, oilName, proportionPct } (must sum to 100)\",\"required\":true},{\"property\":\"batchWeightG\",\"type\":\"number\",\"description\":\"Batch weight in grams (optional, default 400)\",\"required\":false},{\"property\":\"fragranceLoadPct\",\"type\":\"number\",\"description\":\"Fragrance load percent (optional, default 10)\",\"required\":false},{\"property\":\"notes\",\"type\":\"string\",\"description\":\"Tags, descriptors, or replication notes\",\"required\":false}]",
  "func": "const baseUrl = String($vars.moodMnkyApiUrl || '').replace(/\\/+$/, '');\nconst apiKey = $vars.moodMnkyApiKey;\n\nif (!baseUrl) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiUrl' });\nif (!apiKey) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.moodMnkyApiKey (Runtime var / env)' });\nif (!$vars.userId) return JSON.stringify({ ok: false, layer: 'config', message: 'Missing $vars.userId (override vars.userId from embed)' });\n\nconst fetchFn = (typeof fetch === 'function') ? fetch : (globalThis && globalThis.fetch) ? globalThis.fetch.bind(globalThis) : require('node-fetch');\n\nconst body = {\n  userId: $vars.userId,\n  sessionId: $flow.sessionId,\n  chatId: $flow.chatId,\n  name: $name,\n  productType: $productType,\n  fragrances: typeof $fragrances === 'string' ? JSON.parse($fragrances) : $fragrances,\n  batchWeightG: (typeof $batchWeightG !== 'undefined' && $batchWeightG) ? $batchWeightG : 400,\n  fragranceLoadPct: (typeof $fragranceLoadPct !== 'undefined' && $fragranceLoadPct) ? $fragranceLoadPct : 10,\n  notes: typeof $notes !== 'undefined' ? $notes : undefined,\n};\n\nconst timeoutMs = 15000;\nconst controller = typeof AbortController !== 'undefined' ? new AbortController() : null;\nconst timer = controller ? setTimeout(() => controller.abort(), timeoutMs) : null;\n\ntry {\n  const res = await fetchFn(`${baseUrl}/api/flowise/tools/save-blend`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n      'x-moodmnky-session-id': String($flow.sessionId || ''),\n      'x-moodmnky-chat-id': String($flow.chatId || ''),\n      'x-moodmnky-chatflow-id': String($flow.chatflowId || ''),\n    },\n    body: JSON.stringify(body),\n    ...(controller ? { signal: controller.signal } : {}),\n  });\n  const text = await res.text();\n  if (!res.ok) {\n    return JSON.stringify({ ok: false, layer: 'moodmnky_api', status: res.status, statusText: res.statusText, body: text?.slice(0, 2000) });\n  }\n  try { return JSON.stringify(JSON.parse(text)); } catch { return text; }\n} catch (err) {\n  const msg = err?.name === 'AbortError' ? `Request timed out after ${timeoutMs}ms` : (err?.message || String(err));\n  return JSON.stringify({ ok: false, layer: 'network', error: err?.name || 'Error', message: msg });\n} finally {\n  if (timer) clearTimeout(timer);\n}"
}
